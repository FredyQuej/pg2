
services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tesisdb
    volumes:
      - pgdata:/var/lib/postgresql/data

  auth-service:
    build: ./services/auth-service
    environment:
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 4001
      DEFAULT_ADMIN_EMAIL: ${DEFAULT_ADMIN_EMAIL}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD}
      DEFAULT_ADMIN_NAME: ${DEFAULT_ADMIN_NAME}

  events-service:
    build: ./services/events-service
    environment:
      DATABASE_URL: ${DATABASE_URL}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET}
      PORT: 4002

  report-service:
    build: ./services/report-service
    environment:
      DATABASE_URL: ${DATABASE_URL}
      PORT: 4003

  provisioning-service:
    build: ./services/provisioning-service
    environment:
      PORT: 4010
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET}
      EVENTS_PUBLIC_URL: https://${DOMAIN}/events/webhooks/github

  mcp-server:
    build: ./services/mcp-server
    environment:
      MCP_SERVER_PORT: 4020
      MCP_API_KEY: ${MCP_API_KEY}
      EVENTS_URL: http://events-service:4002
      REPORT_URL: http://report-service:4003
      LLM_PROVIDER: ${LLM_PROVIDER}
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_MODEL: ${LLM_MODEL}

  frontend:
    build: ./frontend
    environment:
      VITE_API_AUTH: https://${DOMAIN}/auth
      VITE_API_EVENTS: https://${DOMAIN}/events
      VITE_API_REPORT: https://${DOMAIN}/report
      VITE_API_MCP: https://${DOMAIN}/mcp/rpc
      VITE_MCP_API_KEY: ${MCP_API_KEY}

  nginx:
    build: ./infra/nginx
    depends_on:
      - frontend
      - auth-service
      - events-service
      - report-service
      - provisioning-service
      - mcp-server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - certs:/etc/letsencrypt:ro

volumes:
  pgdata:
  certs:
